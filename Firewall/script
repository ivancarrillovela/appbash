#!/bin/bash

# Detectar si estamos en WSL o en un Linux real
if grep -qi microsoft /proc/version; then
    echo "üñ•Ô∏è Detectado WSL (Windows Subsystem for Linux)"
    powershell_path=$(wslpath "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe")

    while true; do
        read -p "¬øDeseas habilitar o deshabilitar el firewall de Windows? (habilitar/deshabilitar/salir): " accion
        accion=$(echo "$accion" | tr '[:upper:]' '[:lower:]')

        case $accion in
            habilitar)
                echo "üîí Solicitando permisos de administrador para habilitar el firewall..."
                "$powershell_path" -Command "Start-Process powershell -ArgumentList 'Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True' -Verb RunAs -Wait" 2>/dev/null
                resultado=$?

                if [ $resultado -eq 0 ]; then
                    echo "‚úÖ El firewall de Windows se ha habilitado correctamente."
                else
                    echo "‚ùå Has rechazado la ventana emergente o ha ocurrido un error."
                    read -p "¬øDeseas volver a intentarlo? (s√≠/no): " retry
                    retry=$(echo "$retry" | tr '[:upper:]' '[:lower:]')
                    if [[ "$retry" != "s√≠" ]]; then
                        echo "üö™ Saliendo sin habilitar el firewall."
                        break
                    fi
                fi
                ;;

            deshabilitar)
                echo "üîì Solicitando permisos de administrador para deshabilitar el firewall..."
                "$powershell_path" -Command "Start-Process powershell -ArgumentList 'Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False' -Verb RunAs -Wait" 2>/dev/null
                resultado=$?

                if [ $resultado -eq 0 ]; then
                    echo "‚úÖ El firewall de Windows se ha deshabilitado correctamente."
                else
                    echo "‚ùå Has rechazado la ventana emergente o ha ocurrido un error."
                    read -p "¬øDeseas volver a intentarlo? (s√≠/no): " retry
                    retry=$(echo "$retry" | tr '[:upper:]' '[:lower:]')
                    if [[ "$retry" != "s√≠" ]]; then
                        echo "üö™ Saliendo sin deshabilitar el firewall."
                        break
                    fi
                fi
                ;;

            salir)
                echo "üëã Saliendo del script."
                exit 0
                ;;

            *)
                echo "‚ö†Ô∏è Opci√≥n no v√°lida. Por favor, escribe 'habilitar', 'deshabilitar' o 'salir'."
                ;;
        esac
    done

elif [ -f /etc/os-release ]; then
    echo "üêß Detectado Linux real (No WSL)"

    while true; do
        read -p "¬øDeseas habilitar o deshabilitar el firewall de Linux? (habilitar/deshabilitar/salir): " accion
        accion=$(echo "$accion" | tr '[:upper:]' '[:lower:]')

        case $accion in
            habilitar)
                if command -v ufw &>/dev/null; then
                    echo "üîí Habilitando firewall con UFW..."
                    sudo ufw enable 2>/dev/null
                elif command -v firewall-cmd &>/dev/null; then
                    echo "üîí Habilitando firewall con firewalld..."
                    sudo systemctl start firewalld 2>/dev/null
                else
                    echo "‚ö†Ô∏è No se encontr√≥ un firewall compatible en este sistema."
                fi
                ;;

            deshabilitar)
                if command -v ufw &>/dev/null; then
                    echo "üîì Deshabilitando firewall con UFW..."
                    sudo ufw disable 2>/dev/null
                elif command -v firewall-cmd &>/dev/null; then
                    echo "üîì Deshabilitando firewall con firewalld..."
                    sudo systemctl stop firewalld 2>/dev/null
                else
                    echo "‚ö†Ô∏è No se encontr√≥ un firewall compatible en este sistema."
                fi
                ;;

            salir)
                echo "üëã Saliendo del script."
                exit 0
                ;;

            *)
                echo "‚ö†Ô∏è Opci√≥n no v√°lida. Por favor, escribe 'habilitar', 'deshabilitar' o 'salir'."
                ;;
        esac
    done

else
    echo "‚ö†Ô∏è No se pudo detectar el sistema operativo."
    exit 1
fi

echo "‚úÖ Operaci√≥n completada."


